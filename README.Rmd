---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Análise qualidade da casca - mestrado João

## Carregando os pacotes no R
```{r, message=FALSE, error=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(skimr)
library(GGally)
library(ExpDes.pt)
```

## Pré-tratamento dos dados
-carregando o banco de dados;
-mudando os nomes das colunas;

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados<- readxl::read_excel("data-raw/Dados Mestrado João.xlsx") |>
  janitor::clean_names()
dplyr::glimpse(dados)
dados <- dados |> 
  mutate(
    class_peso = case_when(
      peso_g < 53 ~ "pequeno",
      peso_g < 63 ~ "medio",
      peso_g < 73 ~ "grande",
      TRUE ~ "extra_grande"
    )
  )
table(dados$class_peso)
```


- seleção das variáveis para a análise.

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados <- dados |>
  select(data,
         repeticao,
         linhagem,
         nivel_de_fosforo_disp,
         class_peso,
         resistencia_kgf,
         frequencia_ressonante,
         shape_index,
         peso_g,
         altura_de_albumen,
         uh,
         espessura_mm
         ) #|> 
  # mutate(log_frequencia_ressonante = log(frequencia_ressonante))
```

- lidando com os valores perdidos de `resistencia_kgf`;
- definindo as datas da amostragem.

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados <-dados |>
  dplyr::mutate(
    resistencia_kgf = ifelse(resistencia_kgf == "Perdi", NA, resistencia_kgf),
    resistencia_kgf = as.numeric(resistencia_kgf),
    dia=round(as.numeric(difftime(data,"2021-05-13",units = "days"))),
    dia = dplyr::case_when(
      dia < 3 ~ 1,
      dia < 20 ~15,
      dia < 30 ~ 30,
      dia < 45 ~ 45,
      dia < 60 ~ 60
    )
  )
dplyr::glimpse(dados)
```


## Análise de regressão linear 

A análise foi realizada independete dos tratamentos para descrever o comportamento das variáveis ao longo do dias por linhagem.

```{r, message=FALSE, error=FALSE, warning=FALSE}
parametros <- names(dados)[6:(length(dados)-1)]

for(i in 1:length(parametros)){
  da <- dados |>
    select(dia, linhagem, class_peso, parametros[i]) 
  names(da) <- c("dia","linhagem","class_peso","y")
  plot<-da |> 
    dplyr::group_by(dia, linhagem, class_peso) |>
    dplyr::summarise(re=mean(y, na.rm=TRUE)) |>
    ggplot(aes(x=dia, y=re, color=linhagem)) +
    geom_point() +
    geom_smooth(method = "lm")+
    labs(x="Dias",y=parametros[i]) #+
    # facet_wrap(~class_peso)
  print(plot)

  tab <- da |>
    dplyr::group_by(dia,linhagem) |>
    dplyr::summarise(y=mean(y, na.rm=TRUE))
  
  mod <- lm(y~dia + linhagem, data=tab)
  print(summary.lm(mod))
  plot(mod)
}
```

## Estatística descritiva do banco de dados
 - resumo estatístico para todas as variáveios do banco de dados
```{r, message=FALSE, error=FALSE, warning=FALSE}
skim(dados)
```

## Gráfico de linhas
 - Análise para todas as variáveis do banco de dados, por nível de `P`.
 
```{r, message=FALSE, error=FALSE, warning=FALSE}
for(i in 1:length(parametros)){
  da <- dados |>
    select(dia, linhagem, nivel_de_fosforo_disp, parametros[i]) 
  names(da) <- c("dia","linhagem","nivel_de_fosforo_disp","y")
  plot <- da |>
    group_by(dia, nivel_de_fosforo_disp) |> 
    drop_na() |> 
    mutate( y = mean(y), na.rm=TRUE) |> 
    ggplot(aes(x = dia, y = y, color=as.factor(nivel_de_fosforo_disp))) +
    geom_line() +
    labs(color="Nível de Fósforo disponível (%)", x="Dias",y=parametros[i])
  print(plot)
}
```



 ### Independente do dia
 
```{r, message=FALSE, error=FALSE, warning=FALSE}
for(i in 1:length(parametros)){
  da <- dados |>
    select(dia, repeticao, linhagem, nivel_de_fosforo_disp, parametros[i]) 
  names(da) <- c("dia","repeticao","linhagem","nivel_de_fosforo_disp","y")
  plot <- da |> 
    group_by(nivel_de_fosforo_disp, linhagem, repeticao) |>
    summarise(re = mean(y, na.rm=TRUE)) |>
    ggplot(aes(x = as.factor(nivel_de_fosforo_disp), y = re)) +
    geom_boxplot(fill="lightgray") +
    theme_bw() +
    labs(x="Nível de Fósforo disponível (%)",
         y = parametros[i])
  print(plot)
}
```

## Matriz de correlação para linhagem **DEKALB**
```{r, message=FALSE, error=FALSE, warning=FALSE}
classes<-c("medio", "grande")
for(i in 1:2){
  dados  |>
    filter(linhagem == "Dekalb", class_peso == classes[i]) |>
    drop_na() |> 
    select(resistencia_kgf:espessura_mm)  |>
    cor(use = "p")  |>
    corrplot::corrplot()
}
```

### Classe peso do ovo = **MEDIO**


```{r, message=FALSE, error=FALSE, warning=FALSE}
dados |>
  filter(linhagem == "Dekalb", class_peso =="medio") |>
  select(resistencia_kgf:espessura_mm) |>
  ggpairs()
```


### Classe peso do ovo = **GRANDE**

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados |>
  filter(linhagem == "Dekalb", class_peso =="grande") |>
  select(resistencia_kgf:espessura_mm) |>
  ggpairs()
```


## Matriz de correlação para linhagem **H&N**
```{r, message=FALSE, error=FALSE, warning=FALSE}
for(i in 1:2){
  dados  |>
    filter(linhagem == "H&N", class_peso == classes[i]) |>
    drop_na() |> 
    select(resistencia_kgf:espessura_mm)  |>
    cor(use = "p")  |>
    corrplot::corrplot()
}
```

### Classe peso do ovo = **MEDIO**

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados |>
  filter(linhagem == "H&N", class_peso =="medio") |>
  select(resistencia_kgf:espessura_mm) |>
  ggpairs()
```


### Classe peso do ovo = **GRANDE**

```{r, message=FALSE, error=FALSE, warning=FALSE}
dados |>
  filter(linhagem == "H&N", class_peso =="grande") |>
  select(resistencia_kgf:espessura_mm) |>
  ggpairs()
```

## Análise de variância

```{r}
for(i in 1:length(parametros)){
  da <- dados |>
    select(dia, repeticao, linhagem, nivel_de_fosforo_disp, parametros[i]) 
  names(da) <- c("dia","repeticao","linhagem","nivel_de_fosforo_disp","y")
  
  da<- da |> 
    group_by(repeticao, linhagem, nivel_de_fosforo_disp) |> 
    summarise(y = mean(y, na.rm=TRUE))
  linhagem<-da$linhagem
  nivel_de_fosforo <- da$nivel_de_fosforo_disp
  y <- da$y
  print("-------------------------------------------------")
  print(paste0("Variável: ",parametros[i]))
  print("-------------------------------------------------")
  fat2.dic(linhagem,nivel_de_fosforo,y,quali = c(TRUE, FALSE), mcomp = "tukey",
           fac.names = c("Linhagem","Fosforo"))
}
```
 
 
## Adicionando o dia na análise (provisória)

```{r}
for(i in 1:length(parametros)){
  da <- dados |>
    select(dia, repeticao, linhagem, nivel_de_fosforo_disp, parametros[i]) 
  names(da) <- c("dia","repeticao","linhagem","nivel_de_fosforo_disp","y")
  
  da<- da |> 
    group_by(dia, repeticao, linhagem, nivel_de_fosforo_disp) |> 
    summarise(y = mean(y, na.rm=TRUE))
  linhagem<-da$linhagem
  nivel_de_fosforo <- da$nivel_de_fosforo_disp
  y <- da$y
  dia <- da$dia
  print("-------------------------------------------------")
  print(paste0("Variável: ",parametros[i]))
  print("-------------------------------------------------")
  fat3.dic(dia, linhagem,nivel_de_fosforo,y,quali = c(TRUE, TRUE, FALSE), mcomp = "tukey",
           fac.names = c("Dia", "Linhagem","Fosforo"))
}
```

